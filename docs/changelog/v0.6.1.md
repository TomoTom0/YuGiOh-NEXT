# v0.6.1 (2025-12-21)

## New Features

- chrome.storage.local の容量監視機能を追加。150MBを超過した場合、自動的に100MBまで縮小するようにストレージ管理を実装。requestIdleCallback を使用してページ読み込み後のアイドル時に一度だけチェック。Tier別、段階的削除で効率的に容量を回復。（TASK-207）
- デッキコード発行機能を実装。ope=13 でデッキコードを発行後、ope=1 で取得する API パイプラインを構築。DeckInfo に favoriteCount、issuedDeckCode フィールドを追加。（TASK-211, 212, 214）
- デッキ編集画面にメタデータメニューを追加。⋮ボタンをクリックするとドロップダウンメニューが表示され、お気に入り数（スターアイコン）とデッキコード（XMLアイコン + 発行ボタン or クリックでコピー）を表示。メニューは右寄せで幅150px、行高統一、ホバー効果あり。
- 公式デッキ表示ページの情報（お気に入り数、デッキコード）をデッキ編集画面のメタデータメニューに表示。（TASK-181）
- Vue Teleportを使用してダイアログをbody直下に配置し、z-indexスタッキングコンテキストの問題を根本的に解決。SearchFilterDialog、LoadDialog、ImportExportDialog、TagDialog、CategoryDialog、OptionsDialog、ConfirmDialogすべてに対応。（TASK-110）
- デッキリスト一覧取得を必須処理として確保。backgroundDeckInfoFetch 設定による制御を完全に削除し、ページロード時に常に fetchDeckList() を実行。LoadDialog 機能を復旧。（TASK-239）

## Bug Fixes

- 公式デッキ表示画面でcard-tabのinfo-tabにおいて進む/戻るボタンのレイアウトと見やすさを改善。グリッドレイアウト修正、ボタンサイズ拡大20px→28px、SVGアイコン拡大10px→14px、無効時の背景・ボーダー色調整。（TASK-209）
- ImportExportDialogおよびSearchFilterDialog.vueのdialog-bodyにwidth: 100%; box-sizing: border-box;を追加し、パディングを含めて幅が100%になるよう修正。（TASK-216）
- LoadDialog.test.tsを PR #82 の Teleport 対応に修正。31/33 テストが PASS。（TASK-218）
- CategoryDialog, SearchFilterDialog の単体テスト失敗を修正。セレクタ不一致を解消。（TASK-223）
- 結合テスト失敗を修正。HTMLサンプルファイル（card-detail.html, deck-detail-public.html, card-faq-list.html等）のダウンロードスクリプトを改善。（TASK-224）
- deck-thumbnail.ts の画像読み込み処理で無限ループが発生していた問題を修正。promiseAllConcurrent() 関数の実装を修正し、シンプルな Promise.all() + 複数ワーカーパターンに変更。これにより、サムネイル生成が正常に完了するようになった。（TASK-206）
- Dart Sass legacy JS API deprecation 警告を解消。webpack.config.js の sass-loader に implementation オプションを追加し、新しい Dart Sass JavaScript API を明示的に使用。

## Changes

- ESM base への移行完了。package.json に "type": "module" を追加し、CJS ファイル (*.js) を .cjs 拡張に変更。webpack.config.js → webpack.config.cjs、scripts/ の11個の CJS ファイル → .cjs に変更。これにより、Vite の CJS deprecation warning を完全に解消。

## Performance

- deck-cache.ts の calculateDeckHash を FNV-1a ハッシュアルゴリズムに最適化。JSON.stringify() をスキップして高速化。（TASK-205）
- deck-thumbnail.ts の画像読み込みを並列数制限（最大2並列）と Image.decode() の活用で最適化。高負荷なリソース読み込みをより効率的に制御。（TASK-206）
- card-detail-ui.ts の MutationObserver に300msデバウンス処理を追加。パフォーマンス改善。（TASK-203）

## Refactoring

- deck-cache.ts の型安全性を改善。any型をDeckInfo/DeckListItem/DeckCardRef型に置き換えてIDE サポート改善。（TASK-196）
- unified-cache-db.ts の型安全性を改善。MoveHistoryEntry を定義しany型を削減。（TASK-197）
- card-detail-ui.ts の Floating Promise を修正。イベントリスナー内の非同期処理に.catch()を追加。（TASK-198）
- card-detail-ui.ts の innerHTML 使用を setSafeInnerHTML に置き換え。XSS脆弱性を修正。（TASK-199）
- dom-selectors.ts の使用を徹底。card-detail-ui.ts, sortfixCards.ts等でハードコードされたセレクタを置き換え。（TASK-200）

## Repository Management

- manifest.json に unlimitedStorage パーミッションを追加。ストレージ容量監視機能に対応。

## Internal Improvements

### テスト追加・修正

- 全テスト失敗を完全に修正（9件 → 0件）。Test Files: 105 passed (100%)、Tests: 2261 passed | 38 skipped。（TASK-208）
- shuffle関連機能（shuffleCards.ts, sortfixCards.ts）の単体テストを作成（25テスト）。Fisher-Yatesアルゴリズム、sortfix機能、FLIPアニメーション、DOM操作、複数デッキセクション処理を実施。（TASK-193）
- deck-display/DeckDisplayApp.vue の単体テストを作成（27テスト）。CardDetail条件付きレンダリング、HTMLクラス管理、ライフサイクル処理、Store統合、メモリリーク対策を実施。（TASK-194）
- edit-ui/DeckEditLayout.vue の単体テストを作成（40テスト）。レイアウト構造、ローディング状態、デッキセクション、レスポンシブレイアウト、ダイアログ管理、Store統合を実施。（TASK-195）
- card-faq.ts の単体テストを追加（27テストケース）。FAQ一覧取得、FAQ詳細取得、エラーハンドリング等をカバー。（TASK-225）
- デッキ操作、カード検索、カード詳細UI、ytknFetcherの統合テストを作成（59テスト）。モジュール間の通信を検証。（TASK-219）
- PR #82 デッキコード発行機能のブラウザテストを作成（3スクリプト）。test-deck-code-issuance.js、test-card-search-flow.js、test-load-dialog-flow.js を Chrome DevTools Protocol (CDP) で実行。（TASK-220）
- PR #82 デッキコード発行機能の E2E テストを実装（14テストケース）。デッキコード発行フロー、HTMLレスポンスパース、いいね数抽出、ytkn フェッチ、localStorage保存、エラーハンドリング等を検証。（TASK-221）

### テストカバレッジ分析

- PR #82以外の機能のテストカバレッジ包括分析を完了。ユニットテスト2400+個、結合テスト4ファイル、ブラウザテスト5スクリプト、E2Eテスト0個（計画中）を確認。主な課題はLoadDialog.test.ts 24個失敗、E2Eテスト未実装等。（TASK-226）
- 全機能のテストカバレッジ詳細調査を完了。ユニットテスト~1,300個、結合テスト~250個（不足）、E2Eテスト66個、ブラウザテスト14個。LoadDialogとURL状態管理の結合テスト完全欠落を確認。（TASK-227）
- テスト実装ロードマップを作成。Phase 1（高優先度）: いいね数取得E2Eテスト、デッキ編集画面E2Eテスト、LoadDialogテスト修正。Phase 2（中優先度）: デッキ表示フロー結合テスト、URL状態同期E2Eテスト等。（TASK-222）

### 接続規制対策調査

- 12月20日以降の開発内容確認完了。新規コードは接続規制の原因ではないことを確認。（TASK-231）
- 12月20日以降の開発作業内容の詳細調査完了。テストコードはモック化されており通信なし、新規実装コードは最小限であることを確認。（TASK-232）
- LoadDialog関連の全機能におけるオプション化の必要性調査完了。backgroundDeckInfoFetch と enableDeckThumbnailGeneration が既にオプション化済みであることを確認、複数処理の並列実行が接続規制の最有力原因であることを特定。（TASK-233）

## Known Issues

（変更内容をここに記載）

---

**注記**: TASK-167（デッキサムネイル関連）、TASK-184, 185, 186（テスト作成）は v0.6.0 に既に記載済みのため、本リストから除外しました。
