# v0.4.1 変更履歴

リリース日: 2025-11-25

## 新機能

### デッキ操作機能
- **デッキ新規作成**: ope=4ページからytkn（セッショントークン）を取得して新規デッキを作成
- **デッキ複製**: 既存のデッキを複製して新しいデッキを作成
- **デッキ削除**: 不要なデッキを削除
- **NEXT編集ボタン**: 公式デッキ表示画面から独自デッキ編集画面へ遷移するボタンを追加
- **Undo/Redo機能**: デッキ編集の履歴管理（最大100履歴）
  - カード追加/削除/移動の操作を記録
  - Undo/Redoボタンでデッキ状態を復元

### キャッシュシステム刷新
- **UnifiedCacheDB導入**
  - TempCardDBとの統合により、データ構造を統一
  - TableA: カード基本情報（カード名、属性、種族、レベル等）
  - TableB2: カードテキスト・ペンデュラムテキスト分離
  - TableC: カード詳細情報（関連カード、Q&A、収録パック等）
- **stale-while-revalidate戦略**
  - カード詳細タブ表示時、キャッシュを即座に利用しつつバックグラウンドで最新データを取得
  - ユーザー体験とデータ鮮度の両立
- **自動クリーンアップ処理**
  - 古いキャッシュの自動削除
  - ストレージ容量の最適化

### 検索機能大幅強化
- **コマンドモード**
  - チップベースフィルターシステム（英語キーワード）
  - `-`プレフィックスでNOT条件指定（例: `-race:warrior`）
  - 種族の複数入力形式サポート（例: `/race:warrior+spellcaster`）
  - Enterキーで選択中の候補をチップに変換
- **マイデッキ選択機能**
  - 検索モードに「マイデッキ」を追加
  - 手持ちのデッキから直接カードを検索
- **検索入力欄の位置設定**
  - Right Top / Right Bottom / Left Bottom から選択可能
  - ユーザーの好みに応じてレイアウト調整
- **グローバル検索モード**
  - 全セクション共通の検索バー
  - Main/Extra/Side を横断して検索

### タグ・カテゴリフィルタ強化
- **ダイアログ内検索機能**
  - タグ・カテゴリをダイアログ内で検索
  - 大量のタグから目的のものを素早く見つける
- **詳細なフィルタ条件**
  - モンスタータイプ（効果モンスター、シンクロモンスター等）
  - 属性（光・闇・地・水・炎・風）
  - 種族（戦士族、魔法使い族等）
  - レベル/ランク/リンク
  - 複合条件での絞り込み
- **フィルタチップ表示**
  - 適用中のフィルタを小さいアイコンで表示
  - フィルタ状態の視覚化

### UI/UX改善
- **Reloadボタン追加**
  - デッキを再読み込みして最新状態に更新
  - 他のデバイスで編集した内容を反映
- **未保存時の確認ダイアログ**
  - ページ離脱時に警告
  - 誤操作による編集内容の損失を防止
- **Load Dialogリデザイン**
  - カードリスト表示の改善
  - 視認性向上
- **CardListソート機能拡張**
  - 7種類のソートオプション（発売日、名前、ATK、DEF、Lv/Rank、属性、種族）
  - ソート処理の集約
- **設定ダイアログの2x2グリッド化**
  - より見やすいレイアウトに変更

## 改善

### データ構造
- タグマッピングをtag-master-data.tsに一元化
- モンスタータイプを内部キー（英語キー）で判定
- 50音グループを行レベルから文字レベルに変更

### 開発基盤
- バージョン管理スクリプト追加（dev用）
- update-version.sh: 複数ファイルのバージョンを一括更新

## バグ修正

- **CardListのuuid永続化**: 新規カードには最大インデックス+1を付与し、ユニーク性を保証
- **CardDetail再フェッチ問題**: 選択カード変更時にカード詳細を正しく再取得
- **キャッシュ判定条件**: 空配列でもキャッシュを使用するように修正
- **リンクモンスターフィルタ判定**: 正しいビット位置でリンクマーカーを判定

## 技術的詳細

### キャッシュ戦略の実装
```typescript
// stale-while-revalidate
async function getCardDetail(cid: string) {
  // 1. キャッシュから即座に返す
  const cached = await cache.get(cid);
  if (cached) return cached;
  
  // 2. バックグラウンドで最新データを取得
  fetchLatest(cid).then(data => cache.set(cid, data));
  
  return cached;
}
```

### UnifiedCacheDB構造
- TableA: 軽量な基本情報（検索・フィルタリング用）
- TableB2: テキストデータ分離（容量削減）
- TableC: 重い詳細情報（必要時のみロード）

## 影響範囲

- 修正ファイル: 約60個
- 新規ファイル: 約10個
- コミット数: 約110件

## 既知の問題

特になし

## 次バージョンの予定

- オプションページのUI/UX改善（v0.4.2）
- さらなる検索機能の拡充
- パフォーマンスチューニング
