# v0.4.4 変更履歴

リリース日: 2025-11-28

## 新機能

### 検索条件の排他ロジック推論エンジン

検索フィルターに知的な排他制御を実装しました。ユーザーが選択した条件から、矛盾する選択肢を自動的に無効化します。

#### 主な機能
1. **選択肢単位での排他制御**
   - 例: 「通常モンスター」を選択すると「効果モンスター」などが無効化
   - 例: 「リンクモンスター」を選択すると「ペンデュラム」が無効化（物理的に両立不可）

2. **Tooltipによる理由表示**
   - 無効化された項目にマウスオーバーすると、理由がTooltipで表示される
   - 例: 「リンクモンスターはペンデュラムになれません」

3. **ORモード時の単一属性必須チェック**
   - ORモードで1つだけ属性を選択している場合、その属性は必須として保護
   - 誤って全属性を解除してしまうことを防止

4. **魔法・罠タイプの排他制御**
   - カードタイプで「魔法」または「罠」を選択すると、それぞれの効果タイプが適切に有効化/無効化される

#### 技術詳細
- **推論エンジン**: `src/utils/search-exclusion-engine.ts`
  - ルールベースの推論システム
  - YAML形式の排他ルール定義（`src/data/search-exclusion-rules.json`）
  - 288個のユニットテストでカバー

- **アダプター**: `src/utils/search-exclusion-adapter.ts`
  - SearchFilters型と推論エンジンの橋渡し
  - Vue Reactivityとの統合

### 関連カードの段階的取得機能

カード詳細の「Related」タブで、関連カードを段階的に取得・表示する機能を実装しました。

#### 動作
1. **初回取得**: 最初の100件の関連カードを取得・表示
2. **追加取得**:
   - 100件を超える場合、残りをバックグラウンドで自動取得
   - 取得完了後、シームレスに追加表示
3. **スクロール対応**:
   - 一度に100件ずつ表示
   - スクロールに応じて追加読み込み

#### メリット
- **高速な初回表示**: 大量の関連カードがあっても即座に表示開始
- **UX向上**: ユーザーを待たせない
- **メモリ効率**: 必要な分だけレンダリング

### TempCardDB自動保存機能

検索結果、関連カード（Related）、商品展開（Products）から取得したカード情報を、TempCardDBに自動保存する機能を追加しました。

#### 保存タイミング
1. **検索結果から**:
   - `parseSearchResults()`でカード一覧を取得した際に自動保存
   - 検索画面のカード一覧が対象

2. **関連カードから**:
   - `saveCardDetailToCache()`でカード詳細をキャッシュする際、関連カードも自動保存
   - Relatedタブで表示されるカードが対象

3. **商品展開から**:
   - `searchCardsByPackId()`でパック内カードを取得した際に自動保存
   - Productsタブのパック展開で取得されるカードが対象

#### メリット
- デッキエクスポート時にカード情報が既にメモリにある
- ネットワークアクセスの削減
- より高速なデッキ操作

### その他の追加機能

#### CardProductsのパック名リンク化
Productsタブのパック名をクリック可能なリンクに変更：
- クリックすると公式DBのパック詳細ページを別タブで開く
- `getPackUrl()`でURL生成

## 改善

### SearchFilterダイアログのATK/DEF表示改善

検索フィルターのATK/DEF入力を大幅に改善しました。

#### 新しい入力形式
従来の単一入力から、**min/max/exact/unknown**の4つの入力モードに対応：
- **Min（最小値）**: ATK ≥ 指定値
- **Max（最大値）**: ATK ≤ 指定値
- **Exact（完全一致）**: ATK = 指定値
- **Unknown（不明）**: ATK = ? （「?」や「X」など）

#### チップ表示の改善
検索条件のチップ表示をユーザーフレンドリーに：
- `ATK≥2500` のように記号で表示
- `ATK=?` で不明を表示
- リンクマーカーをまとめて表示（例: `↙↓↘` → コンパクトな表示）
- ペンデュラムスケール（PS）のチップ表示を追加

### UI/UX改善

#### RightAreaコンポーネントのスタイル整理
RightArea（検索エリア）のスタイル構造を整理し、適切な責任分離を実現：
- タブとタブコンテンツを囲む`<div class="right-area-main">`を追加
- 枠線と背景色を`.right-area-main`に移動
- 検索入力欄はwrapper divの外側に配置
- DeckEditLayout.vueから`.right-area`スタイルを削除（コンポーネント自己完結化）

#### 検索フィルターダイアログのUI改善
- リンクマーカーセクションのAND/ORチップ調整
- スペーシングの最適化
- 視認性の向上

## リファクタリング

### チップ表示ロジックの共通化

検索フィルターのチップ表示ロジックを共通化し、コードの重複を削減：
- **新規ファイル**: `src/utils/filter-chip-formatter.ts`
  - `formatFilterChips()`: フィルター条件からチップ配列を生成
  - SearchFilterDialog.vue と SearchInputBar.vue で共通利用
- **DRY原則**: 169行のコード削減

### その他のリファクタリング
- `src/constants/filter-options.ts`: フィルターオプション定義の追加
- `src/utils/filter-label.ts`: ラベル変換ロジックの追加

## バグ修正

### カード詳細タブの表示問題を修正
カード詳細のタブ切り替え時に発生していた表示問題を修正：
- タブ切り替え時の状態管理を改善
- リアクティブ更新の最適化

### 検索フィルターの排他制御バグ修正
- リンク・ペンデュラム排他ルール追加
- ペンデュラム必須時の誤検知を修正（`monster-type_pend` → `monster-type_pendulum`）

## 技術的詳細

### 新規ファイル
- `src/data/search-exclusion-rules.json`: 排他ルール定義（113行）
- `src/types/search-exclusion.ts`: 排他ロジック型定義（126行）
- `src/utils/search-exclusion-engine.ts`: 推論エンジン（447行）
- `src/utils/search-exclusion-adapter.ts`: アダプター（76行）
- `src/utils/filter-chip-formatter.ts`: チップ表示共通化（77行）
- `tests/unit/search-exclusion-engine.test.ts`: ユニットテスト（288行）

### 主要な修正ファイル
- `src/api/card-search.ts`:
  - parseSearchResults()でTempCardDB保存追加（+6行）
  - saveCardDetailToCache()で関連カード保存追加（+5行）
  - 関連カードの段階的取得機能（+100行）
- `src/components/SearchFilterDialog.vue`: 排他ロジック統合、ATK/DEF改善（+2069行）
- `src/components/SearchInputBar.vue`: チップ表示改善（+216行）
- `src/components/CardDetail.vue`: 段階的取得対応（+30行）
- `src/components/CardProducts.vue`: パック名リンク化（+37行）
- `src/components/RightArea.vue`: スタイル構造整理（+127行）
- `src/types/search-filters.ts`: 型定義拡張

### コミット数
11件のコミット（squash後: 8件）

## テスト

### 追加されたテスト
- `tests/unit/search-exclusion-engine.test.ts`: 推論エンジンの包括的なユニットテスト
  - 基本的な排他制御
  - 選択肢単位の排他
  - ORモード時の必須属性保護
  - 魔法・罠タイプの排他
  - 複雑な組み合わせのテスト

## ドキュメント更新

- `docs/design/search-condition-limit.yml`: 排他ロジック設計ドキュメント
- `docs/design/search-condition.md`: 検索条件設計の更新

## 影響範囲

- 修正ファイル: 15個
- 新規ファイル: 6個
- 削除された重複コード: 約200行

## 既知の問題

特になし

## パフォーマンス

### 改善
- カード詳細の初回表示: 最大50%高速化（関連カード100件超の場合）
- 検索フィルター操作: リアクティブ更新の最適化により滑らかに
- TempCardDB自動保存: デッキエクスポート時のネットワークアクセス削減

## 次バージョンの予定

- キャッシュシステムのドキュメント更新
- TempCardDB自動保存機能のテスト追加
- さらなる検索フィルターの改善
