# v0.5.5 (2025-12-09)

**主な変更**: 大規模リファクタリング、バグ修正、デバッグログ整理

## 新機能

### CardList.vue ソート複数キー実装
- ATK/DEF/レベルソートで同値のカードをカード名順にソート
- 第2キー（カード名昇順）を追加:
  - atk_desc/asc: 同ATKの場合はカード名昇順
  - def_desc/asc: 同DEFの場合はカード名昇順
  - level_desc/asc: 同レベルの場合はカード名昇順
- maxIndexMapのクリア処理を実装（カード配列変更時にリセット）

### useDeckUndoRedo composableを実装
- デッキ編集のUndo/Redo機能をcomposableとして分離
- コマンド履歴管理（最大100履歴）
- メモリ使用量の最適化

## バグ修正

### 設定マイグレーションバグ修正
- 旧形式の設定キー（searchInputPosition等）が削除されずに残存していた問題を修正
- 削除対象: searchInputPosition, defaultSearchMode, enableMouseOperations, changeFavicon, keyboardShortcuts
- 全7コンポーネントを appSettings.ux.* パスに変更
- deprecated設定パスの使用箇所: 20箇所 → 0箇所

### 循環参照の解消
- SearchFilterDialog と SearchInputBar の循環参照を解消
- コンポーネント間の依存関係を整理

### ドキュメント修正
- リンク切れの修正（CONTRIBUTING.md, docs/changelog/README.md等）
- バージョン番号の統一（v0.5.3 → v0.5.4 → v0.5.5）
- 存在しないファイルへのリンクを修正

## パフォーマンス改善

### categoryMatchedCardIds の最適化
- カテゴリマッチング検索のパフォーマンス向上
- 検索アルゴリズムの最適化

## テスト追加

### DeckSection.vue テストカバレッジ追加
- canMoveCard関数の完全テスト
- セクション間のカード移動ルールを検証

### CardList.vue テスト追加
- ソート複数キーのテストケース（5件）
- maxIndexMapクリア処理のテスト

### useDeckPersistence composable テスト
- デッキ永続化機能のユニットテスト
- 読み込み・保存機能の検証

## リファクタリング

### deck-edit.ts の大規模リファクタリング（272行削減）
- UUID生成ロジックを `src/utils/deck-uuid-generator.ts` に分離
- FLIPアニメーションを `src/composables/deck/useFLIPAnimation.ts` に分離
- Fisher-Yatesシャッフルを `src/utils/array-shuffle.ts` に分離
- ソート比較関数を `src/composables/deck/useDeckCardSorter.ts` に分離
  - 7段階のソート優先順位を実装
  - カテゴリ優先、末尾配置、モンスタータイプ、レベル等
- カテゴリマッチングを `src/composables/deck/useCategoryMatcher.ts` に分離
  - 2段階検索アルゴリズム（カテゴリラベル → カード名参照）
- ファイルサイズ: 2084行 → 1812行（13.0%削減）

### DeckMetadata.vue スタイルリファクタリング（397行削減）
- DeckMetadataHeader.vue との重複スタイル削除（250行）
  - ボタン、ドロップダウン、アニメーション等
- DeckMetadataTags.vue との重複スタイル削除（150行）
  - チップスタイルをテーマ変数ベースの改良版に移行
  - ダークモード対応のハードコードされたグラデーション削除
- DeckMetadataDescription.vue との重複スタイル削除（63行）
  - 説明テキストエリア、ラベル、文字カウント等
- ファイルサイズ: 887行 → 490行（44.8%削減）

### RightArea.vue スタイルリファクタリング（271行削減）
- CardDetail.vue との重複タブスタイル削除（30行）
- CardInfoTab.vue レイアウトスタイル削除（210行）
  - カード詳細表示、ステータス、リンクマーカー等
  - 効果テキスト、セクションタイトル等
- CardList.vue との重複カードスタイル削除（31行）
- ファイルサイズ: 790行 → 519行（34.3%削減）

### 検索フィルター機能のリファクタリング
- SearchFilterDialog Phase 1: useFilterLogic抽出
  - フィルターロジックをcomposableに分離
- 検索フィルター機能全体のリファクタリング
  - コンポーネント間の依存関係整理

### deck-edit.ts 追加リファクタリング
- Phase 2: sortDisplayOrderForOfficial をリファクタリング
  - ソート処理の最適化

### デバッグログの整理
- 本番不要な `console.log()` と `[DEBUG]` プレフィックス付きログを削除
- 削除対象ファイル:
  - `src/utils/mapping-manager.ts` - 約20箇所のデバッグログ削除
  - `src/components/searchInputBar/composables/useSearchExecution.ts` - 5箇所のデバッグログ削除
  - `src/composables/useSearchHistory.ts` - 4箇所のデバッグログ削除
- 削減効果: バンドルサイズ 1.86 MiB → 1.85 MiB（約11 KiB削減）

### デバッグログ運用ルールの策定
- `console.debug()` を推奨（ブラウザのVerboseレベルでのみ表示）
- `console.log()` は本番前に削除必須
- `console.warn()` / `console.error()` は本番でも保持
- CLAUDE.md にデバッグログのルールを追加
  - ログレベル使い分け表
  - 削除タイミングのガイドライン
  - Chrome DevToolsでの表示方法

## 技術的詳細

### 新規ファイル

**Composables:**
- `src/composables/deck/useFLIPAnimation.ts` - FLIPアニメーション処理
- `src/composables/deck/useDeckCardSorter.ts` - デッキカード比較関数生成
- `src/composables/deck/useCategoryMatcher.ts` - カテゴリマッチング処理
- `src/composables/deck/useDeckPersistence.ts` - デッキ永続化機能
- `src/composables/deck/useDeckUndoRedo.ts` - Undo/Redo機能
- `src/composables/deck/README.md` - Composablesドキュメント

**Utils:**
- `src/utils/deck-uuid-generator.ts` - UUID生成の一元管理
- `src/utils/array-shuffle.ts` - 汎用Fisher-Yatesシャッフル

**Types:**
- `src/types/window.d.ts` - Window型拡張定義

**Tests:**
- `src/composables/deck/__tests__/useDeckPersistence.test.ts`
- `tests/sample/card_search_ja.html` - 日本語カード検索ページのサンプル

### 主な変更ファイル
- `src/stores/deck-edit.ts` - ロジック分離により272行削減
- `src/components/DeckMetadata.vue` - 重複スタイル削除により397行削減
- `src/components/RightArea.vue` - 重複スタイル削除により271行削減
- `src/components/CardList.vue` - ソート複数キー実装
- `src/components/search-filter/FilterTab.vue` - フィルターロジック分離
- `src/utils/mapping-manager.ts` - デバッグログ削除
- `CLAUDE.md` - デバッグログ運用ルール追加

### コード削減サマリー
| ファイル | 削減前 | 削減後 | 削減量 | 削減率 |
|---------|--------|--------|--------|--------|
| deck-edit.ts | 2084行 | 1812行 | 272行 | 13.0% |
| DeckMetadata.vue | 887行 | 490行 | 397行 | 44.8% |
| RightArea.vue | 790行 | 519行 | 271行 | 34.3% |
| **合計** | **3761行** | **2821行** | **940行** | **25.0%** |

### 設計原則
- **単一責任の原則（SRP）**: 各モジュールが1つの明確な責務を持つ
- **Composableパターン**: ロジックの再利用性とテスト可能性の向上
- **Pure Functions**: 副作用のない関数で予測可能な動作を実現
- **テーマ変数の活用**: ハードコードされたスタイルをテーマ変数に移行

### ドキュメント
- `docs/internal-reviews/reports/deck-edit-refactoring-plan.md` - deck-edit.ts リファクタリング計画
- `docs/internal-reviews/reports/DeckMetadata-style-refactoring-completion.md` - DeckMetadata.vue 完了レポート
- `docs/internal-reviews/reports/RightArea-style-refactoring-phase1-completion.md` - RightArea.vue 完了レポート

## 影響範囲
- コードの可読性と保守性が大幅に向上
- 破壊的変更なし、後方互換性維持
- 全てのビルド・デプロイが成功
