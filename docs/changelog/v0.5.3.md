# v0.5.3 変更履歴

リリース日: 2025-12-04

## バグ修正

### デッキ新規作成失敗問題を修正

v0.5.0+ で発生していた「デッキ新規作成ボタンをクリックしてもデッキが作成されない」問題を解決しました。

**問題の症状**:
- 「New Deck」ボタンをクリックしても新しいデッキが作成されない
- コンソールにはエラーメッセージが出ない
- 公式APIからは HTTP 200 で正常なレスポンスが返ってくる

**根本原因**:
URLクラスの `searchParams` を使ったURL構築により、**パラメータの順序が保証されなくなっていた**

- v0.4.5では: `?ope=6&wname=MemberDeck&cgid=...&ytkn=...`
- v0.5.0+では: URLクラス経由で再構築された際に順序が変わる可能性
- 公式APIがパラメータ順序に依存していたため、新しいデッキが作成されない現象が発生

**修正内容**:

1. **buildApiUrl()に `noLocale` フラグを追加**
   - request_locale を絶対に付与しない制御を追加
   ```typescript
   export function buildApiUrl(
     path: string,
     gameType: CardGameType,
     params?: URLSearchParams,
     noLocale?: boolean  // 新規追加
   ): string
   ```

2. **URL構築方法を改善**
   - ベースURLのみを buildApiUrl() で取得
   - パラメータは手動で文字列連結で追加（順序を保証）
   ```typescript
   // 修正前
   const path = `member_deck.action?ope=6&wname=${wname}&cgid=${cgid}&ytkn=${ytkn}`;
   const url = buildApiUrl(path, gameType);  // URLクラス経由で再構築

   // 修正後
   const baseUrl = buildApiUrl('member_deck.action', gameType, undefined, true);
   const url = `${baseUrl}?ope=6&wname=${wname}&cgid=${cgid}&ytkn=${ytkn}`;  // 順序保証
   ```

3. **対象ファイル**:
   - `src/utils/url-builder.ts`: buildApiUrl() に noLocale フラグを追加
   - `src/api/deck-operations.ts`: createNewDeckInternal() の URL構築方法を改善
   - `src/utils/ytkn-fetcher.ts`: fetchYtknFromDeckList() の URL構築方法を改善

**検証結果**:
- ✅ 実機で「New Deck」ボタンをクリック → デッキ作成成功を確認
- ✅ デッキ読み込み → 新規作成したデッキが表示されることを確認

## 変更内容の詳細

### 影響範囲
- 修正ファイル: 3個
  - `src/utils/url-builder.ts` (noLocale フラグ追加)
  - `src/api/deck-operations.ts` (URL構築改善)
  - `src/utils/ytkn-fetcher.ts` (URL構築改善)
- テスト修正: 0個（既存テストはすべてパス）

### 互換性
- **既存機能への影響**: なし（バグ修正のみ）
- **UIの変更**: なし
- **APIの変更**: buildApiUrl()に noLocale パラメータを追加（オプション、デフォルト: false）

## 次バージョンの予定
- REQ-19 Phase 3: テストカバレッジ拡大 (deck-operations, deck-edit store)
- その他バグ修正・機能改善
