# v0.5.2 変更履歴

リリース日: 2025-12-04

## バグ修正

### ATK/DEFの`'-'`文字列をそのまま保持

カード詳細ページのパース処理で、ATK/DEFが`'-'`の場合に`undefined`に変換していた問題を修正：

**問題**:
- リンクモンスターなど、攻撃力・守備力が`'-'`（ハイフン）のカードでは、値が表示されなくなる
- 本来は`'-'`をそのまま文字列として保持すべき

**修正内容**:
```typescript
// 修正前: '-' を undefined に変換
atk = atkValue === '-' ? undefined : /^\d+$/.test(atkValue) ? parseInt(atkValue, 10) : atkValue;

// 修正後: '-' をそのまま保持
atk = /^\d+$/.test(atkValue) ? parseInt(atkValue, 10) : atkValue;
```

**対象**:
- `src/api/card-search.ts`: ATK パース処理（line 1134）
- `src/api/card-search.ts`: DEF パース処理（line 1144）

### 多言語カード追加時の言語情報継承

デッキにカードを追加・移動する際、カード自体が持つ言語情報を引き継ぐように修正：

**問題**:
- カードを追加・移動する際、常に`detectLanguage(document)`（現在のページ言語）を使用していた
- 異なる言語で取得したカード情報を追加する場合、言語情報が不正になる可能性

**修正内容**:

1. **カード追加時** (`src/stores/deck-edit.ts:346`)
   ```typescript
   // 修正前: 常にドキュメントの言語を使用
   lang: detectLanguage(document)

   // 修正後: カード自体の言語を使用
   lang: card.lang
   ```

2. **カード移動時** (`src/stores/deck-edit.ts:640`)
   ```typescript
   // 修正前: 常にドキュメントの言語を使用
   lang: detectLanguage(document)

   // 修正後: 移動するカードの言語を引き継ぐ
   lang: movingDisplayCard.lang
   ```

**メリット**:
- 多言語対応環境でカード情報の一貫性を保証
- デッキに異なる言語のカードが混在する場合、各カードの言語を正しく保持

## テスト

### 包括的なユニットテストスイート追加

総計46個の新規ユニットテストを追加し、テストカバレッジを大幅に拡大：

**新規テストファイル**:
- `tests/unit/parser/deck-parser.test.ts` (11個のテスト)
- `tests/unit/parser/deck-list-parser.test.ts` (8個のテスト)
- `tests/unit/parser/deck-detail-parser.test.ts` (8個のテスト)
- `tests/unit/utils/card-utils.test.ts` (4個のテスト)
- `tests/unit/components/CardDetail.test.ts` (5個のテスト)
- `tests/unit/components/RightArea.test.ts` (5個のテスト)
- `tests/unit/components/DeckMetadata.test.ts` (5個のテスト)

**テスト実行結果**:
- テストファイル: 69個成功、2個スキップ (71個)
- テスト数: 894個成功、10個スキップ (904個)
- 成功率: 98.9%

**テスト対象領域**:
- デッキ情報パーサー（デッキ番号、名前、スタイル、コードなど）
- デッキ一覧パーサー（複数デッキ取得、エッジケース）
- カード検索・参照ユーティリティ
- コンポーネントマウント確認（タブ構造、プロップ処理）

## 変更内容の詳細

### 影響範囲
- 修正ファイル: 2個
  - `src/api/card-search.ts` (ATK/DEF修正)
  - `src/stores/deck-edit.ts` (lang修正)
- 新規テストファイル: 7個
- テスト追加: 46個

### 検証方法

```bash
# テスト実行
bun run test:vitest

# 特定領域のテストのみ実行
bun run test:vitest tests/unit/parser
bun run test:vitest tests/unit/utils
bun run test:vitest tests/unit/components
```

## 互換性

- **既存機能への影響**: なし（バグ修正のみ）
- **UIの変更**: なし
- **APIの変更**: なし

## 次バージョンの予定

- 型チェック対応（TypeScript errors）
- その他テストカバレッジの拡大
