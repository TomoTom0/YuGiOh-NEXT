# REQ-19 最終報告：単体・結合テストのカバレッジ欠落分析調査

**報告日**: 2025-12-03
**調査期間**: Phase 1 (分類・整理) + Phase 2 (詳細分析)
**完了日時**: 2025-12-03 18:00
**対象範囲**: 単体テスト (tests/unit/) + 結合テスト (tests/combine/)

---

## エグゼクティブサマリー

### 調査対象

| 項目 | 数値 |
|------|------|
| 総コンポーネント・関数数 | 395個 |
| テスト実装率 | 28.9% (114個) |
| テスト欠落率 | **67.8%** (268個) |
| テスト更新漏れ | 6ファイル (19日以上差分) |
| 廃止テスト漏れ | 0個 (健全な状態) |

### 最終カバレッジ

```
✅ テスト実装済み:   114個 (28.9%)
⚠️ 部分実装:         13個 (3.3%)
❌ テスト欠落:       268個 (67.8%)

全体テストカバレッジ: 29.4%
```

### 主な課題

1. **Parser 領域**: 94.4% 欠落 (17/18関数) - 最優先
2. **Vue Component**: 78.3% 欠落 (18/23) - 高優先度
3. **API 層**: 71.4% 欠落 (30/42関数) - 高優先度
4. **テスト更新漏れ**: 19日古いテスト 6個 - 早急な検証必要
5. **廃止テスト**: なし (削除前からテスト欠落が多数)

---

## Phase 2 詳細分析結果

### 1. テスト更新漏れの分析

#### 緊急対応が必要（19日以上の差分）

| ソースファイル | 最終修正日 | テスト最終修正日 | 差分 | 状態 | 推奨アクション |
|-------------|----------|-------------|-----|------|-------------|
| src/api/card-search.ts | 2025-12-02 | 2025-11-13 | 19日 | ⚠️ 更新漏れ | テスト内容の検証・更新 |
| src/api/card-faq.ts | 2025-12-03 | 2025-11-13 | 20日 | ⚠️ 更新漏れ | テスト内容の検証・更新 |
| src/api/deck-operations.ts | 2025-12-03 | 2025-11-13 | 20日 | ⚠️ 更新漏れ | テスト内容の検証・更新 |
| src/stores/deck-edit.ts | 2025-12-03 | 2025-11-13 | 20日 | ⚠️ 更新漏れ | テスト内容の検証・更新 |
| src/components/DeckCard.vue | 2025-12-03 | 2025-11-13 | 20日 | ⚠️ 更新漏れ | テスト内容の検証・更新 |
| src/content/parser/deck-detail-parser.ts | 2025-12-02 | 2025-11-13 | 19日 | ⚠️ 更新漏れ | テスト内容の検証・更新 |

**原因**: 2025-11-13 のテスト修正以降、API 統一化 (url-builder.ts) や機能追加が加わったが、テストが追いついていない

**リスク評価**: 🔴 **高** - 実装と仕様の乖離が発生している可能性

#### 最近修正されたがテストが古い（2-13日の差分）

| ソースファイル | 最終修正日 | テスト最終修正日 | 差分 | 推奨アクション |
|-------------|----------|-------------|-----|-------------|
| src/components/CardList.vue | 2025-12-02 | 2025-11-29 | 2日 | テスト更新の確認 |
| src/components/DeckSection.vue | 2025-12-02 | 2025-11-23 | 9日 | テスト更新の確認 |
| src/stores/settings.ts | 2025-12-02 | 2025-11-18 | 13日 | テスト更新の確認 |

#### テスト同期済み（差分0-1日）✅

正常に同期されているファイル:
- src/utils/unified-cache-db.ts (2025-12-03)
- src/utils/url-builder.ts (2025-12-03)
- src/utils/mapping-manager.ts (2025-12-03)

---

### 2. 廃止テスト漏れの分析

#### 結論: 廃止テスト漏れ**なし** ✅

**削除されたコードの歴史**:
- src/background/mapping-updater.ts (削除済み, テストなし)
- その他削除ファイル (削除前からテストなし)

**分析結果**:
- 削除されたコードに対する孤児テストなし
- **ただし**: 削除前からテストが欠落していた (欠陥)

**設計評価**:
- ✅ テストなしのコードを削除しているため、孤児テストが生じない
- ❌ そもそもテストが欠落していた (機能が十分テストされていない)

**推奨**: テスト欠落を埋めることで、今後の削除判断時により安全性を確保

---

### 3. テスト欠落の優先度別分析

#### 🔴 超高優先度（2-3週間で実装推奨）- 24個

**A) Parser 領域** (17個 - テスト欠落率 94.4%)

| 対象 | 関数数 | 理由 | リスク |
|------|--------|------|--------|
| deck-parser.ts | 2 | デッキHTMLパース (新規2025-12-02) | 🔴 高 |
| deck-detail-parser.ts extract関数群 | 13 | 詳細ページのデータ抽出 | 🔴 高 |
| deck-list-parser.ts | 2 | デッキ一覧パース | 🔴 中 |

**テスト実装方法**: サンプル HTML ファイル (tests/combine/data/) を活用したユニットテスト

**B) API 層** (3個)

| 対象 | 関数数 | 理由 | リスク |
|------|--------|------|--------|
| image-utils.ts | 8 | 属性/アイコン URL生成 | 🟡 中 (単純な関数) |
| getNextEffectiveDate | 1 | 月計算ロジック (1/4/7/10月) | 🟡 中 |
| buildCardImageUrl | 1 | 画像 URL構築 | 🟡 中 |

**テスト実装難度**: 低 (純粋な関数, UIなし)

**C) Vue Component** (2個)

| 対象 | 理由 | リスク |
|------|------|--------|
| CardDetail.vue | カード詳細表示 (複数タブ) | 🔴 高 |
| RightArea.vue | 右側エリア統合 | 🔴 高 |

**D) Store** (4個)

| 対象 | 理由 | リスク |
|------|------|--------|
| deck-edit.ts: saveDeck/loadDeck | デッキ I/O | 🔴 高 |
| deck-edit.ts: displayOrder操作 | ソート順序管理 | 🟡 中 |

**E) Utility** (3個)

| 対象 | 理由 | 新規 |
|------|------|------|
| extract-mappings.ts | マッピング抽出 (HTML) | ✨ 2025-12-03 作成 |
| card-utils.ts | カード情報取得 | - |
| search-exclusion-adapter.ts | 検索フィルタ adapter | - |

#### 🟡 中優先度（3-4週間で実装推奨）- 35個

| 領域 | 対象 | 数 | テスト方法 |
|------|------|---|----------|
| API | searchCards系 (searchCardsByName, searchCardById等) | 3 | APIモック統合テスト |
| API | deck-operations系 (createNewDeck, deleteDeck等) | 5 | E2E テスト (Chrome CDP) |
| Vue | ImportDialog, ExportDialog | 2 | ファイル I/O テスト |
| Vue | SearchInputBar, CategoryDialog | 2 | UI インタラクションテスト |
| Utility | settings.ts | 7 | chrome.storage.local モック |
| Utility | deck-metadata-loader.ts | 9 | DOM + ストレージモック |
| Utility | card-limit.ts, temp-card-db.ts | 4 | メモリキャッシュテスト |
| Store | deck-edit.ts: displayOrder操作 | 10 | state更新テスト |
| Store | deck-edit.ts: UI状態管理 | 15 | state更新テスト |

#### 🟢 低優先度（オプション）- 12個

| 領域 | 対象 | 数 | 補足 |
|------|------|---|------|
| Vue | Toast.vue, OptionsDialog.vue | 2 | UI テスト難度高 |
| API | parseForbiddenLimitedHtml | 1 | 補助機能 |
| Utility | card-animation.ts, extension-context-checker.ts | 6 | ブラウザ API依存 |
| Utility | filter-label.ts, label-utils.ts | 13 | データ定義のみ |

---

## 推奨実装ロードマップ

### フェーズ 1（1-2週間）- Quick Wins + 緊急対応

**A) 緊急対応 - テスト更新漏れの検証** (1日)
```
[ ] src/api/card-search.ts のテスト内容検証
    → request_locale ルール、パラメータ順序の確認
[ ] src/api/deck-operations.ts のテスト内容検証
    → API エンドポイント、パラメータ変更の確認
[ ] src/stores/deck-edit.ts のテスト内容検証
    → 54回修正の頻出ファイル、仕様変更の確認
```

**B) Parser テスト実装** (5-7日)
```
[ ] deck-parser.ts のユニットテスト (2関数)
[ ] deck-list-parser.ts のユニットテスト (2関数)
[ ] deck-detail-parser.ts extract関数群のテスト (13関数)
    → サンプル HTML 活用（tests/combine/data/ から）
```

**C) API シンプル関数テスト** (2-3日)
```
[ ] image-utils.ts 全8関数のテスト化
[ ] getNextEffectiveDate の月計算テスト
[ ] buildCardImageUrl のテスト化
```

**期待されるテスト数**: 25-30個
**期待されるカバレッジ向上**: 29.4% → 38%

---

### フェーズ 2（2-4週間）- Core Functions

**A) API 検索関数テスト** (3-5日)
```
[ ] searchCardsByName のテスト化
[ ] searchCardById のテスト化
[ ] searchCards (SearchOptions複合テスト)
```

**B) Store アクション拡充テスト** (3-5日)
```
[ ] deck-edit.ts: saveDeck/loadDeck の統合テスト
[ ] displayOrder 操作のテスト (10個アクション)
[ ] UI 状態管理のテスト (15個)
```

**C) Utility テスト充実化** (3-5日)
```
[ ] settings.ts の完全テスト化 (7関数)
[ ] deck-metadata-loader.ts のテスト化 (9関数)
[ ] extract-mappings.ts のテスト化 (12関数) ← 新規 2025-12-03
[ ] card-utils.ts のテスト化 (4関数)
```

**期待されるテスト数**: 60-70個
**期待されるカバレッジ向上**: 38% → 55%

---

### フェーズ 3（1ヶ月以上）- Integration & Polish

**A) E2E テスト統合** (2-3週間)
```
[ ] deck-operations: createNewDeck, deleteDeck, saveDeck の E2E テスト
[ ] 複数言語テスト (ja, en, ko, de)
```

**B) Vue コンポーネントテスト** (1-2週間)
```
[ ] CardDetail.vue のコンポーネントテスト
[ ] ImportDialog/ExportDialog のファイル I/O テスト
[ ] SearchInputBar, CategoryDialog の UI テスト
```

**C) CI/CD 統合** (1週間)
```
[ ] カバレッジ自動計測の導入
[ ] テスト失敗時の自動通知
[ ] デプロイ前テスト必須化
```

**期待されるテスト数**: 100個以上
**期待されるカバレッジ向上**: 55% → 75%+

---

## 領域別カバレッジ改善プラン

### 現状 vs 目標

| 領域 | 現状 | 短期目標 (2-3w) | 中期目標 (1-2m) | 長期目標 (3m) |
|------|------|------------|-----------|-----------|
| **Vue Component** | 21.7% | 35% | 60% | 80% |
| **API** | 28.6% | 45% | 65% | 85% |
| **Utility** | 57.1% | 70% | 80% | 90% |
| **Store** | 65% | 80% | 90% | 95% |
| **Parser** | 5.6% | 40% | 70% | 90% |
| **全体** | **29.4%** | **45%** | **65%** | **85%** |

---

## リスク評価

### 高リスク領域（テスト欠落による本番バグの可能性が高い）

| 領域 | 関数 | リスク | 理由 |
|------|------|--------|------|
| Parser | deck-parser.ts | 🔴 高 | HTML パース失敗 → カード読み込み失敗 |
| Parser | deck-detail-parser.ts | 🔴 高 | メタデータ抽出失敗 → デッキ情報消失 |
| API | extract-mappings.ts | 🔴 高 | マッピング不正 → 検索フィルタ破損 |
| Vue | CardDetail.vue | 🔴 高 | タブ機能未テスト → UI 崩壊 |
| Store | deck-edit.ts | 🔴 高 | saveDeck 未テスト → デッキ保存失敗 |
| API | searchCards系 | 🟡 中 | 検索機能欠落 → ユーザー操作困難 |
| Utility | settings.ts | 🟡 中 | 設定保存失敗 → ユーザー設定喪失 |

---

## 統計サマリー

### 総数

```
調査対象: 395個コンポーネント・関数

テスト状況:
  ✅ 実装済み:     114個 (28.9%)
  ⚠️ 部分実装:      13個 (3.3%)
  ❌ 欠落:         268個 (67.8%)

テスト更新:
  ✅ 同期済み:      3ファイル
  ⚠️ 更新漏れ:     6ファイル (19日以上差分)
  ⚠️ 古いテスト:   3ファイル (2-13日差分)

廃止テスト:
  ✅ 廃止漏れ:     0個 (健全)
  ❌ 欠落テスト:  268個 (削除前からテストなし)
```

### 優先度別テスト欠落

```
🔴 超高優先度: 24個 (2-3週間)
🟡 中優先度:   35個 (3-4週間)
🟢 低優先度:   12個 (オプション)
────────────────────
合計欠落:      71個 (すぐ対応すべき)
+ その他:     197個 (中長期)
```

---

## 成果物チェックリスト

### Phase 1
- ✅ 領域別分類表（全395個）
- ✅ テスト状況の明確化（実装/部分/欠落）
- ✅ リスク評価（高/中/低）

### Phase 2
- ✅ テスト更新漏れの検出（6ファイル）
- ✅ 廃止テストの確認（0個 - 健全）
- ✅ テスト欠落の優先度分類（24+35+12個）
- ✅ 実装ロードマップ（3フェーズ）
- ✅ リスク評価と改善プラン

### 最終レポート
- ✅ `docs/internal-reviews/reports/19_test_coverage_gap_analysis_report.md` (このファイル)

---

## 結論と推奨事項

### 結論

1. **テストカバレッジは低い（29.4%）**が、**系統的な改善が可能**
2. **テスト更新漏れ**は早急に検証が必要（API層・ストア層）
3. **廃止テスト漏れはない**が、**欠落テストが大量**（268個）
4. **優先順位をつけた実装**で 8-12週間で 75%以上のカバレッジ達成は可能

### 推奨アクション

**直後（1-2日）**:
- [ ] テスト更新漏れの検証（6ファイル）
- [ ] deck-parser.ts, deck-list-parser.ts のテスト実装着手

**2週間以内**:
- [ ] Parser テスト 25個完成
- [ ] API シンプル関数テスト完成
- [ ] テストカバレッジ 38%達成

**1ヶ月以内**:
- [ ] Store/Utility テスト充実
- [ ] テストカバレッジ 55%達成
- [ ] CI/CD 統合の検討

**3ヶ月目標**:
- [ ] テストカバレッジ 85%達成
- [ ] 自動テスト必須化

---

**報告完了**
調査期間: 2025-12-03 (1日)
調査対象: 395個コンポーネント・関数
テスト欠落: 268個（優先度付けして対応可能）

