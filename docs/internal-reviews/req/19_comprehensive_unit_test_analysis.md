# 依頼書: 単体・結合テストの包括的分析と充実化

## 依頼番号
REQ-19

## 依頼日
2025-12-03

## 目的
component・機能・関数単位でテストの抜け漏れを系統的に特定し、単体・結合テストレベルの充実化を図る。

## 背景

### 現状
v0.5.1では、複数のバグ（Props エクスポーズ、Proxy 変換、deepMerge、request_locale ルール）が検出されました。これらのバグパターンは、単体テストが存在すれば検出されていたはずのものです。

### 課題
プロジェクト全体に同等レベルのテスト欠落領域が存在し、未発見のバグが埋もれている可能性があります。これまでのテスト追加は個別的でしたが、**体系的な分析が不可欠**です。

### 成功基準
- 各 component・機能・関数の**責任範囲を明確化**
- 各責任に対する**テストカバレッジの欠落箇所を特定**
- 優先度別にテスト実装計画を立案
- テスト欠落による**リスク評価を可視化**

## 依頼内容

### ステージ 1: コンポーネント・機能・関数の分類と責任分析（Phase 1）

#### 1.1 調査対象の分類

以下の観点で、プロジェクト全体を分析します：

**A) Vue コンポーネント領域**
- `src/components/` 配下：データ表示・ユーザー入力・状態管理
- `src/content/edit-ui/` 配下：拡張機能 UI（デッキ編集等）
- `src/content/deck-recipe/` 配下：デッキ表示 UI（画像等）

責任分析項目：
- Props 受け渡しの正確性（Props エクスポーズバグの防止）
- 状態変更時の DOM 更新（nextTick 遵守確認）
- イベントハンドラの動作
- Pinia/Store統合時の型安全性（Proxy 変換対応確認）

**B) API・データ取得領域**
- `src/api/` 配下：各種 API 呼び出し（検索、詳細取得、FAQ等）
- `src/utils/url-builder.ts`：URL 構築と request_locale 付与
- `src/utils/unified-cache-db.ts`：キャッシュ管理（言語別 TTL）

責任分析項目：
- URL パラメータの正確性（request_locale の付与ルール）
- Promise チェーンの正確な実装
- エラーハンドリング（API 失敗時の動作）
- キャッシュの一貫性（言語別管理、TTL境界値）

**C) 状態管理領域**
- `src/stores/` 配下：Pinia ストア（deck-edit, settings, card-detail等）
- `src/utils/` 配下：複雑なロジック（deepMerge, 言語検出等）

責任分析項目：
- ストア状態変更の一貫性
- computed の正確性
- actions の副作用管理
- ユーティリティ関数の境界値テスト

**D) パーサー・変換領域**
- `src/content/parser/` 配下：HTML パース、データ変換
- `src/utils/` 配下：マッピング変換等

責任分析項目：
- HTML パース時の エッジケース（空の要素、特殊文字等）
- 言語別マッピング（race, attribute, 効果種別等）
- マイグレーション（旧形式→新形式）

#### 1.2 各領域のテスト欠落箇所を特定

以下の基準で分析：

| 領域 | 単体テスト | 結合テスト | E2Eテスト | 優先度 |
|------|-----------|-----------|---------|-------|
| Vue Component | ❌ 大部分 | ⚠️ 部分的 | ❌ 手動 | 🔴 高 |
| API・URL構築 | ✅ 部分的 | ⚠️ 部分的 | ❌ 手動 | 🔴 高 |
| 状態管理 | ✅ 部分的 | ⚠️ 部分的 | ❌ 手動 | 🟡 中 |
| パーサー | ⚠️ 部分的 | ❌ 不足 | ❌ 手動 | 🟡 中 |
| ユーティリティ | ✅ 部分的 | ⚠️ 部分的 | - | 🟢 低 |

#### 1.3 成果物

`docs/internal-reviews/reports/19_test_coverage_analysis.md` に以下を記載：

1. **領域別テスト一覧表**
   - 各領域の component・機能・関数
   - 現在のテスト状況（実装済み/欠落/不完全）
   - テストカバレッジの概算値

2. **欠落箇所の詳細分析**
   - 各欠落テストケースの説明
   - テスト欠落による**リスク評価**（高/中/低）
   - テスト実装の難易度（易/中/難）

3. **優先度別テスト実装計画**
   - Phase 2 で実装すべきテスト（優先度順）
   - 各テストの推定ファイル数・テストケース数

4. **関連ファイルマッピング**
   - テスト対象 → テストファイル の対応表
   - 依存関係の可視化

---

### ステージ 2: テスト実装計画の策定と実装（Phase 2）

#### 2.1 Phase 1 の成果を基に、優先度別にテストを実装

優先度 🔴 高：
- [ ] Vue Component テスト（setup return の Props エクスポーズ確認）
- [ ] API URL 構築テスト（request_locale ルール網羅）
- [ ] Pinia ストアテスト（Proxy 変換対応確認）

優先度 🟡 中：
- [ ] パーサーテスト（言語別マッピング、エッジケース）
- [ ] キャッシュ管理テスト（言語別 TTL、マイグレーション）
- [ ] ユーティリティ関数テスト（deepMerge 配列対応、言語検出等）

優先度 🟢 低：
- [ ] E2E シナリオテスト（複合操作、エラーリカバリー等）

#### 2.2 テスト実装ガイドライン

**必須項目：**
1. **ソースコードから仕様を確認**
   - 推測でテストを書かない
   - 実装ファイルで実際に使用されているクラス名・属性・セレクタを確認

2. **DOM 更新と async 処理**
   - `nextTick()` の必要性を確認
   - Promise チェーンの正確さを検証

3. **モックの適切な使用**
   - chrome API、fetch、localStorage等を正確にモック
   - 実装の副作用を正しく反映

4. **エッジケースの網羅**
   - 境界値テスト（TTL ちょうど、未満、超過など）
   - 空値、null、undefined の処理
   - 言語別パス（ja, en, ko等の全言語対応確認）

#### 2.3 成果物

`tests/unit/` および `tests/combine/` に新規テストファイルを作成：

- Vue Component テスト（優先度順）
- API・URL テスト（追加ルール）
- ストア統合テスト
- パーサー・変換テスト
- ユーティリティテスト（追加ケース）

各テストは以下を満たすこと：
- **テストファイル名**: `{対象領域}/{機能名}/{関数名}.test.ts`
- **テストケース数**: 各機能に対し最低 5 ケース
- **モック管理**: 各テストで必要なモックを明示
- **ドキュメント**: テストの意図をコメントで記載

#### 2.4 提出レポート

`docs/internal-reviews/reports/19_test_implementation_report.md` に以下を記載：

1. **実装したテストの一覧**
   - ファイル名、テストケース数、カバレッジ範囲

2. **テスト実行結果**
   - 合計テスト数、パス数、失敗数
   - 実行時間

3. **カバレッジの改善状況**
   - Phase 1 での欠落箇所に対するカバレッジの向上度
   - 未実装箇所と理由

4. **発見されたバグ・問題点**
   - テスト実装過程で判明した問題
   - 修正内容と関連コミット

5. **次フェーズへの推奨事項**
   - 残存する欠落テスト
   - ブラウザテスト（E2E）実装時期

---

## 成果物

### Phase 1 成果物
- `docs/internal-reviews/reports/19_test_coverage_analysis.md`
  - 領域別テスト分析表
  - 欠落箇所リスト（優先度・難易度付き）
  - リスク評価

### Phase 2 成果物
- `tests/unit/` および `tests/combine/` の新規テストファイル
- `docs/internal-reviews/reports/19_test_implementation_report.md`
  - テスト実装の進捗報告
  - カバレッジ改善の定量化

---

## スケジュール

### Phase 1: コンポーネント・機能・関数分析
- **期間**: 1-2 日
- **成果物**: テスト欠落分析レポート
- **確認**: 分析内容のレビュー、優先度判定

### Phase 2: テスト実装
- **期間**: 3-5 日
- **実装順序**: 優先度 🔴 高 → 🟡 中 → 🟢 低
- **確認**: テスト実行結果、カバレッジ確認

### ブラウザテスト（E2E）実装
- **時期**: Phase 2 完了後
- **対象**: 多言語対応デッキ読み込み、複合操作シナリオ等

---

## 期限

- Phase 1: 2025-12-04（明日）
- Phase 2: 2025-12-08 までに完了
- ブラウザテスト: 別途検討

---

## 備考

1. **テスト実装時の基本原則**
   - ソースコードから仕様を確認すること（推測厳禁）
   - Vue/Pinia の内部プロパティ（`__vue_app__`, `$pinia._s`等）にアクセスしないこと
   - DOM 操作は公開属性・セレクタのみを使用

2. **テスト実行コマンド**
   - 単体テスト: `npm run test:vitest -- {テストファイル}`
   - 全テスト: `npm run test:vitest`
   - UI表示: `npm run test:vitest:ui`

3. **関連リソース**
   - `.claude/common-mistakes.md`: よくあるミス集
   - 既存テスト: `tests/unit/` 配下の実装例
   - ソースコード解析: serena ツールで symbol、referencing検索

4. **品質保証**
   - Phase 2 実装後、カバレッジ向上度を定量化
   - 新規テストは全て PASSして提出
   - コミットメッセージに REQ-19 を記載
