# 依頼書: 単体・結合テストのカバレッジ欠落分析調査

## 依頼番号
REQ-19

## 依頼日
2025-12-03

## 目的
単体・結合テストレベルで、component・機能・関数単位の分類を行い、テストのぬけ漏れ・更新漏れ・廃止漏れを系統的に特定する。

## 背景

### 現状
v0.5.1では複数のバグ（Props エクスポーズ、Proxy 変換、deepMerge、request_locale ルール）が検出されました。これらは単体テストが存在すれば検出されていたはずです。

### 課題
プロジェクト全体のテスト欠落状況が可視化されていません。どの領域にテストが足りないのか、古いテストがないか、廃止されたコードに対するテストが残っていないかが不明確です。

### 成功基準
- 各領域（Vue Component、API、状態管理、パーサー等）の component・機能・関数を網羅的に列挙
- 各々に対するテスト状況（実装済み/欠落/不完全）を明確化
- テスト欠落・更新漏れ・廃止漏れのリスク評価を可視化

## 依頼内容

### 段階1：Component・機能・関数の分類・整理調査

#### 1.1 調査対象の領域分類

以下の領域ごとに、**全ての** component・機能・関数を列挙・整理します：

**A) Vue Component 領域**
- `src/components/` 配下
  - SearchInputBar.vue、CardList.vue、CardDetail.vue、DeckEditLayout.vue等
- `src/content/edit-ui/` 配下
  - デッキ編集 UI コンポーネント
- `src/content/deck-recipe/` 配下
  - デッキ表示 UI コンポーネント

**B) API・データ取得領域**
- `src/api/` 配下
  - card-search.ts、card-faq.ts、card-detail.ts等
  - 各 API 関数（searchCards、getCardDetail、fetchAdditionalPages等）

**C) ユーティリティ・ロジック領域**
- `src/utils/` 配下
  - url-builder.ts、unified-cache-db.ts、language-detector.ts
  - mapping-manager.ts、extract-mappings.ts等
  - 各ユーティリティ関数

**D) 状態管理領域**
- `src/stores/` 配下
  - deck-edit.ts、settings.ts、card-detail.ts等
  - 各 Pinia ストアと computed/actions

**E) パーサー・変換領域**
- `src/content/parser/` 配下
  - deck-parser.ts、deck-detail-parser.ts等
  - HTML パース関数、データ変換関数

#### 1.2 各領域の分類・整理内容

各領域について、以下の情報を整理します：

| 項目 | 内容 |
|------|------|
| **Component/関数名** | 正確な関数名・クラス名 |
| **責任範囲** | この関数が担当する処理内容 |
| **現在のテスト状況** | ✅ 実装済み / ⚠️ 部分的 / ❌ 欠落 |
| **テストファイル** | 対応するテストファイル（あれば） |
| **更新状況** | 最終修正日、テストが古い可能性 |
| **廃止状況** | 廃止予定のコード、不要なテスト |

---

### 段階2：テスト欠落・更新漏れ・廃止漏れ分析調査

#### 2.1 テスト欠落箇所の特定

段階1の分類に基づいて、以下を確認：

**A) テスト欠落の確認**
- 各領域で「❌ 欠落」と判定された component・機能・関数
- 欠落の理由（テスト実装が難しい/優先度が低い等）
- 欠落による**リスク評価**（高/中/低）
  - 高：本質的な機能、多くのコードから呼び出される
  - 中：補足機能、限定的な呼び出し
  - 低：デバッグ用、頻出しない機能

**B) テスト更新漏れの確認**
- 最後にテストが修正されてから、ソースコードがどれだけ変わったか
- 仕様変更・リファクタリング後にテストが更新されているか
- 古いテストが存在していないか（廃止すべき項目のテスト）

**C) テスト廃止漏れの確認**
- 廃止されたコード・関数に対するテストが残っていないか
- 不要なテストファイル・テストケースが存在していないか
- テスト対象が既に削除されているテストの特定

#### 2.2 調査メソッド

**ソースコード分析：**
- 各ファイルで export されている関数・クラス・component を列挙
- 実装の変更履歴を git log で確認
- 削除されたファイルの痕跡を確認

**テストコード分析：**
- 各テストファイルが何をテストしているか確認
- テスト対象の関数が実装ファイルに存在するか確認
- テスト内容がソースコードの現実装と一致しているか確認

**カバレッジ分析：**
- 理想的にはカバレッジツール出力を参考に
- 実装不可能な場合は、手動で「テストの有無」を判定

#### 2.3 成果物

`docs/internal-reviews/reports/19_test_coverage_gap_analysis.md` に以下を記載：

1. **段階1：領域別分類表**

   | 領域 | Component/関数 | 責任範囲 | テスト状況 | 更新状況 | 廃止状況 |
   |------|---|---|---|---|---|
   | Vue Component | SearchInputBar.vue | 検索入力UI | ❌ 欠落 | - | - |
   | （以下、全領域） | ... | ... | ... | ... | ... |

2. **段階2：テスト欠落・更新漏れ・廃止漏れ分析**

   **A) テスト欠落リスト（優先度順）**
   - 優先度 🔴 高：欠落テスト一覧、リスク理由
   - 優先度 🟡 中：欠落テスト一覧
   - 優先度 🟢 低：欠落テスト一覧

   **B) テスト更新漏れ一覧**
   - テストファイル名
   - 最終更新日
   - ソースコード最終変更日
   - 差分の概要
   - 更新が必要か否か

   **C) テスト廃止漏れ一覧**
   - テストファイル名・テストケース
   - テスト対象の関数・コンポーネント
   - 対象が廃止されているか否か
   - 廃止提案

3. **統計情報**
   - 総 component/機能数：X個
   - テスト実装済み：Y個（カバレッジ率 Z%）
   - テスト欠落：A個
   - テスト更新漏れ：B個
   - テスト廃止漏れ：C個

4. **優先度別アクション項目**
   - 優先度 🔴 高：すぐに対応すべきテスト欠落
   - 優先度 🟡 中：次のスプリントで対応
   - 優先度 🟢 低：将来の実装候補

---

## 成果物

### 最終成果物
`docs/internal-reviews/reports/19_test_coverage_gap_analysis.md`

内容：
- 段階1：領域別 component・機能・関数分類表（全体像）
- 段階2：テスト欠落・更新漏れ・廃止漏れ分析結果（欠落詳細、統計、優先度）

**成果物は「調査結果のレポート」のみです。テスト実装は含みません。**

---

## スケジュール

### 段階1：分類・整理調査
- **期間**：1-2日
- **作業内容**：全領域の component・機能・関数を網羅的に列挙・整理
- **成果物**：分類表（draft）

### 段階2：ぬけ漏れ・更新漏れ・廃止漏れ分析
- **期間**：2-3日
- **作業内容**：段階1の分類表に基づいて、テスト状況を詳細分析
- **成果物**：最終分析レポート

**合計期間**：3-5日

---

## 期限

- 2025-12-08 までに完了

---

## 備考

1. **調査範囲**
   - 単体テスト（`tests/unit/`）と結合テスト（`tests/combine/`）のみ
   - E2E・ブラウザテストは対象外

2. **テスト対象外**
   - ブラウザテスト（tests/browser/）は後続タスク（pending.md 参照）

3. **参考資料**
   - 既存テストファイル：`tests/unit/`, `tests/combine/`
   - ソースコード：`src/`
   - git 履歴：変更状況確認用
   - `.claude/common-mistakes.md`：テスト実装の注意点（参考）

4. **報告方法**
   - `docs/internal-reviews/reports/19_test_coverage_gap_analysis.md` を作成
   - 表形式で見やすくまとめる
   - 優先度別にソート
   - 統計値を明示
